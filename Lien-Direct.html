<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lien direct</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts (JetBrains Mono for that hacker feel) -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-dark: #0f111a;
            --bg-panel: #1a1d2d;
            --accent: #00ff9d;
            --accent-dim: rgba(0, 255, 157, 0.1);
            --text-main: #f0f4f8;
            --text-muted: #a0aab8;
            --danger: #ff4b4b;
            --border-color: #30363d;
            --input-bg: #0d0f14;
        }

        [data-theme="light"] {
            --bg-dark: #f5f7fa;
            --bg-panel: #ffffff;
            --accent: #00a86b;
            --accent-dim: rgba(0, 168, 107, 0.1);
            --text-main: #1a1a2e;
            --text-muted: #5a6270;
            --danger: #dc3545;
            --border-color: #d1d5db;
            --input-bg: #f0f2f5;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        .login-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .login-card .text-muted {
            color: var(--text-muted) !important;
        }

        .role-selector .btn-check:checked + .btn-outline-success {
            background-color: var(--accent);
            color: #000;
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-dim);
        }

        .btn-connect {
            background: var(--accent);
            color: #000;
            font-weight: 700;
            border: none;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            transition: all 0.3s;
        }
        .btn-connect:hover {
            background: #00cc7d;
            box-shadow: 0 0 20px var(--accent-dim);
        }
        .btn-connect:disabled {
            background: #333;
            color: #666;
        }

        /* --- Main Interface --- */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .app-container.active {
            opacity: 1;
            pointer-events: all;
        }

        .status-bar {
            height: 60px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        .connection-status {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: #666;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            transition: background 0.3s;
        }
        .status-dot.connected { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .status-dot.error { background: var(--danger); }
        .status-dot.waiting { background: #ffcc00; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .workspace {
            flex: 1;
            display: flex;
            padding: 1rem;
            gap: 1rem;
        }

        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .panel-header {
            padding: 10px 15px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 15px;
            resize: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            line-height: 1.5;
            outline: none;
        }
        
        textarea::placeholder { color: var(--text-muted); opacity: 0.6; }

        #remote-text {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] #remote-text {
            background: rgba(0, 0, 0, 0.03);
        }

        .encryption-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0, 255, 157, 0.1);
            color: var(--accent);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }
        .char-counter {
            font-size: 0.7rem;
            color: var(--text-muted);
            padding: 5px 15px;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid var(--border-color);
            text-align: right;
        }
        .btn-copy {
            background: transparent;
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-copy:hover {
            background: var(--accent);
            color: #000;
        }
        .btn-copy.copied {
            background: var(--accent);
            color: #000;
        }

        /* Theme toggle button */
        .btn-theme {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .btn-theme:hover {
            background: var(--accent-dim);
            border-color: var(--accent);
        }

        /* Login form inputs for light mode */
        .login-card .form-control,
        .login-card .input-group-text {
            background-color: var(--input-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-main) !important;
        }

        .login-card .form-control::placeholder {
            color: var(--text-muted);
        }

        .login-card .btn-outline-secondary {
            border-color: var(--border-color);
            color: var(--text-muted);
        }

        .login-card .btn-outline-success {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* About Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }
        .about-modal {
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            width: 100%;
            max-width: 550px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .about-modal h4 {
            color: var(--accent);
            margin-bottom: 1.5rem;
        }
        .about-modal .feature-item {
            display: flex;
            gap: 12px;
            margin-bottom: 1rem;
            align-items: flex-start;
        }
        .about-modal .feature-icon {
            color: var(--accent);
            font-size: 1.1rem;
            min-width: 24px;
            text-align: center;
        }
        .about-modal .feature-text {
            font-size: 0.85rem;
            line-height: 1.5;
        }
        .about-modal .feature-text strong {
            color: var(--text-main);
        }
        .about-modal .feature-text span {
            color: var(--text-muted);
        }
        .about-modal hr {
            border-color: var(--border-color);
            margin: 1.5rem 0;
        }
        .about-modal .tech-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 1rem;
        }
        .about-modal .tech-badge {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--accent-dim);
            color: var(--accent);
            border: 1px solid rgba(0, 255, 157, 0.2);
        }
        .btn-about {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 4px 8px;
            transition: color 0.2s;
        }
        .btn-about:hover {
            color: var(--accent);
        }
    </style>
</head>
<body>

    <!-- ABOUT MODAL -->
    <div class="modal-overlay" id="aboutModal">
        <div class="about-modal">
            <div class="d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-shield-alt me-2"></i>À propos de Lien direct</h4>
                <button class="btn-about" onclick="closeAbout()" title="Fermer">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-lock"></i></div>
                <div class="feature-text">
                    <strong>Chiffrement de bout en bout</strong><br>
                    <span>Tous les messages sont chiffrés avec AES-256-GCM avant de quitter votre appareil. La phrase secrète partagée sert à dériver la clé de chiffrement via PBKDF2 (100&nbsp;000 itérations). Même le serveur de signalisation ne peut pas lire vos données.</span>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-network-wired"></i></div>
                <div class="feature-text">
                    <strong>Vrai P2P (pair à pair)</strong><br>
                    <span>Une fois connecté, les données circulent directement entre les navigateurs via WebRTC. Aucun serveur infonuagique ne stocke ni ne relaie vos messages&nbsp;— il y a seulement un bref échange via un serveur de signalisation pour établir le lien.</span>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-bolt"></i></div>
                <div class="feature-text">
                    <strong>Temps réel</strong><br>
                    <span>Le texte est transmis à mesure que vous tapez, avec une latence minimale.</span>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-feather"></i></div>
                <div class="feature-text">
                    <strong>Simple et léger</strong><br>
                    <span>Un seul fichier HTML, rien à installer. Ça roule entièrement dans votre navigateur avec l’API Web Crypto native&nbsp;— pas de compte, pas de traçage, pas de collecte de données.</span>
                </div>
            </div>

            <div class="feature-item">
                <div class="feature-icon"><i class="fas fa-key"></i></div>
                <div class="feature-text">
                    <strong>Phrase secrète partagée</strong><br>
                    <span>Les deux personnes conviennent d’une phrase secrète à l’avance (hors ligne). Elle sert à générer l’identifiant de connexion et la clé de chiffrement&nbsp;— aucun échange de clé en clair sur le réseau.</span>
                </div>
            </div>

            <hr>

            <div style="font-size: 0.8rem; color: var(--text-muted);">
                <strong style="color: var(--text-main);">Comment ça marche&nbsp;:</strong>
                Les deux personnes entrent la même phrase secrète → Ça génère un identifiant de session unique et une clé AES-256 → L’hôte attend, l’invité se connecte → Tout est chiffré localement avant l’envoi.
            </div>

            <div class="tech-badges">
                <span class="tech-badge">WebRTC</span>
                <span class="tech-badge">AES-256-GCM</span>
                <span class="tech-badge">PBKDF2</span>
                <span class="tech-badge">Web Crypto API</span>
                <span class="tech-badge">PeerJS</span>
            </div>
        </div>
    </div>

    <!-- LOGIN / SETUP SCREEN -->
    <div id="login-overlay">
        <div class="login-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0"><i class="fas fa-shield-alt text-success"></i> Lien direct</h3>
                <div>
                    <button class="btn-about me-2" onclick="openAbout()" title="À propos">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn-theme" id="loginThemeToggle" title="Changer le thème">
                        <i class="fas fa-sun"></i>
                    </button>
                </div>
            </div>
            <p class="text-muted text-center small mb-4">Chiffré de bout en bout, pair à pair, en temps réel</p>

            <div class="mb-4">
                <label class="form-label small text-uppercase text-muted">1. Choisir un rôle</label>
                <div class="btn-group w-100 role-selector" role="group">
                    <input type="radio" class="btn-check" name="role" id="roleHost" value="host" checked>
                    <label class="btn btn-outline-success" for="roleHost"><i class="fas fa-server"></i> Héberger</label>

                    <input type="radio" class="btn-check" name="role" id="roleJoin" value="join">
                    <label class="btn btn-outline-success" for="roleJoin"><i class="fas fa-satellite-dish"></i> Se joindre</label>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label small text-uppercase text-muted">2. Phrase secrète partagée</label>
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-light"><i class="fas fa-key"></i></span>
                    <input type="password" id="secretKey" class="form-control bg-dark border-secondary text-light" placeholder="Entrez la phrase secrète">
                    <button class="btn btn-outline-secondary" type="button" id="togglePass">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-text text-muted" style="font-size: 0.75rem;">
                    * Sert à générer la clé de chiffrement et l’identifiant de connexion.
                </div>
            </div>

            <button id="btnConnect" class="btn-connect" onclick="initApp()">ÉTABLIR LE LIEN</button>
            <div id="login-msg" class="text-center mt-3 text-danger small"></div>
        </div>
    </div>

    <!-- MAIN APP UI -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <div class="status-bar">
            <div class="brand fw-bold"><i class="fas fa-terminal text-success"></i> LIEN DIRECT</div>
            
            <div class="connection-status">
                <span id="statusText">Initialisation...</span>
                <div id="statusDot" class="status-dot"></div>
                <button class="btn-about ms-3" onclick="openAbout()" title="À propos">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button class="btn-theme ms-2" id="appThemeToggle" title="Changer le thème">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="location.reload()">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>

        <!-- Work Area -->
        <div class="workspace">
            <!-- Local Input -->
            <div class="editor-panel">
                <div class="panel-header">
                    <span><i class="fas fa-keyboard me-2"></i> Texte local</span>
                    <span class="encryption-badge"><i class="fas fa-lock"></i> AES-GCM-256</span>
                </div>
                <textarea id="local-text" placeholder="Tapez ici pour envoyer des données de façon sécurisée…" spellcheck="false" aria-label="Zone de texte locale"></textarea>
                <div class="char-counter"><span id="local-char-count">0</span> caractères</div>
            </div>

            <!-- Remote Output -->
            <div class="editor-panel">
                <div class="panel-header">
                    <span><i class="fas fa-satellite me-2"></i> Flux distant</span>
                    <div>
                        <button class="btn-copy" id="btnCopy" title="Copier dans le presse-papiers"><i class="fas fa-copy"></i> Copier</button>
                        <span class="encryption-badge ms-2" id="remote-status"><i class="fas fa-wifi"></i> En attente</span>
                    </div>
                </div>
                <textarea id="remote-text" readonly placeholder="Messages entrants…" spellcheck="false" aria-label="Flux de texte distant"></textarea>
                <div class="char-counter"><span id="remote-char-count">0</span> caractères reçus</div>
            </div>
        </div>
    </div>

    <script>
        // --- ABOUT MODAL ---
        function openAbout() {
            const modal = document.getElementById('aboutModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeAbout() {
            const modal = document.getElementById('aboutModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // Close modal on backdrop click
        document.getElementById('aboutModal').addEventListener('click', (e) => {
            if (e.target.id === 'aboutModal') closeAbout();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAbout();
        });

        // --- THEME MANAGEMENT ---
        function initTheme() {
            const savedTheme = localStorage.getItem('lien-direct-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcons(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('lien-direct-theme', newTheme);
            updateThemeIcons(newTheme);
        }

        function updateThemeIcons(theme) {
            const icon = theme === 'dark' ? 'fa-sun' : 'fa-moon';
            document.querySelectorAll('#loginThemeToggle i, #appThemeToggle i').forEach(el => {
                el.className = `fas ${icon}`;
            });
        }

        // Initialize theme on page load
        initTheme();

        // Theme toggle event listeners
        document.getElementById('loginThemeToggle').addEventListener('click', toggleTheme);
        document.getElementById('appThemeToggle').addEventListener('click', toggleTheme);

        // --- GLOBAL VARIABLES ---
        let peer = null;
        let conn = null;
        let encryptionKey = null; // CryptoKey object
        let sendTimeout = null; // For debouncing
        const APP_PREFIX = "p2p_channel_v1_"; // Shared prefix for cross-app compatibility
        const DEBOUNCE_MS = 150; // Debounce delay in milliseconds
        const CONNECTION_TIMEOUT_MS = 15000; // 15 second timeout for joining

        // --- UI HANDLERS ---
        document.getElementById('togglePass').addEventListener('click', () => {
            const input = document.getElementById('secretKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        // Copy to clipboard functionality
        document.getElementById('btnCopy').addEventListener('click', async () => {
            const remoteText = document.getElementById('remote-text').value;
            const btn = document.getElementById('btnCopy');
            try {
                await navigator.clipboard.writeText(remoteText);
                btn.innerHTML = '<i class="fas fa-check"></i> Copié';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy"></i> Copier';
                    btn.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Échec de la copie:', err);
            }
        });

        // --- CRYPTO FUNCTIONS (Web Crypto API) ---

        // 1. Derive a 256-bit AES-GCM key from the user's password using PBKDF2
        async function deriveKey(password) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw", 
                enc.encode(password), 
                { name: "PBKDF2" }, 
                false, 
                ["deriveKey"]
            );

            const salt = enc.encode("SECURE_CHANNEL_STATIC_SALT_V1"); 

            return window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        // 2. Encrypt Data
        async function encryptData(text) {
            if (!encryptionKey) return null;
            const enc = new TextEncoder();
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encodedText = enc.encode(text);

            const encryptedBuffer = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                encryptionKey,
                encodedText
            );

            return JSON.stringify({
                iv: Array.from(iv),
                data: Array.from(new Uint8Array(encryptedBuffer))
            });
        }

        // 3. Decrypt Data
        async function decryptData(jsonString) {
            if (!encryptionKey) return "";
            try {
                const payload = JSON.parse(jsonString);
                const iv = new Uint8Array(payload.iv);
                const data = new Uint8Array(payload.data);

                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    encryptionKey,
                    data
                );

                const dec = new TextDecoder();
                return dec.decode(decryptedBuffer);
            } catch (e) {
                console.error("Échec du déchiffrement:", e);
                return "[ERREUR DE DÉCHIFFREMENT - CLÉ INCORRECTE?]";
            }
        }

        // 4. Generate a deterministic ID based on the password (SHA-256)
        async function generateRoomId(password) {
            const enc = new TextEncoder();
            const data = enc.encode(password + "ROOM_ID_SALT");
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex.substring(0, 16);
        }


        // --- MAIN APP LOGIC ---

        async function initApp() {
            const secret = document.getElementById('secretKey').value;
            const role = document.querySelector('input[name="role"]:checked').value;
            const btn = document.getElementById('btnConnect');
            const msg = document.getElementById('login-msg');

            if (secret.length < 4) {
                msg.innerText = "La phrase secrète est trop courte.";
                return;
            }

            btn.disabled = true;
            btn.innerText = "GÉNÉRATION DE LA CLÉ...";

            try {
                encryptionKey = await deriveKey(secret);

                const roomId = await generateRoomId(secret);
                const hostId = `${APP_PREFIX}${roomId}_HOST`;

                btn.innerText = "CONNEXION AU SERVEUR DE SIGNALISATION...";

                if (role === 'host') {
                    setupHost(hostId);
                } else {
                    setupJoiner(hostId);
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "Erreur d'initialisation du moteur crypto.";
                btn.disabled = false;
            }
        }

        function setupHost(myId) {
            peer = new Peer(myId, {
                debug: 2
            });

            peer.on('open', (id) => {
                transitionToApp("En attente de l’autre personne...", "waiting");
                peer.on('connection', (c) => {
                    handleConnection(c);
                });
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    alert("Identifiant déjà utilisé. Quelqu’un héberge déjà avec cette phrase secrète. Essayez de vous joindre à la place.");
                    location.reload();
                } else {
                    handleError(err);
                }
            });
        }

        function setupJoiner(targetId) {
            peer = new Peer(null, {
                debug: 2
            });

            let connectionTimeout = null;

            peer.on('open', (id) => {
                transitionToApp("Connexion à l’hôte...", "waiting");

                connectionTimeout = setTimeout(() => {
                    updateStatus("Délai expiré — hôte introuvable", "error");
                    if (peer) peer.destroy();
                }, CONNECTION_TIMEOUT_MS);

                const c = peer.connect(targetId, { reliable: true });
                
                c.on('open', () => {
                    clearTimeout(connectionTimeout);
                });
                
                c.on('error', (err) => {
                    clearTimeout(connectionTimeout);
                    updateStatus("Échec de connexion à l’hôte", "error");
                });

                handleConnection(c);
            });

            peer.on('error', (err) => {
                clearTimeout(connectionTimeout);
                if (err.type === 'peer-unavailable') {
                    updateStatus("Hôte introuvable — vérifiez votre phrase secrète", "error");
                } else {
                    handleError(err);
                }
            });
        }

        function handleConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                updateStatus("LIEN SÉCURISÉ ÉTABLI", "connected");
                document.getElementById('remote-status').innerHTML = '<i class="fas fa-link"></i> En ligne';
                document.getElementById('remote-status').classList.add('text-success');
            });

            conn.on('data', async (data) => {
                const text = await decryptData(data);
                document.getElementById('remote-text').value = text;
                document.getElementById('remote-char-count').textContent = text.length;
            });

            conn.on('close', () => {
                updateStatus("L’autre personne s’est déconnectée", "error");
                conn = null;
            });
            
            conn.on('error', (err) => {
                console.error('Erreur de connexion:', err);
                updateStatus("Erreur de connexion", "error");
            });
        }

        function handleError(err) {
            console.error(err);
            const msg = document.getElementById('login-msg');
            msg.innerText = "Erreur de connexion : " + err.type;
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnConnect').innerText = "RÉESSAYER";
        }

        // --- TRANSITIONS & UPDATES ---

        function transitionToApp(initialStatus, dotClass) {
            document.getElementById('login-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
            }, 500);
            updateStatus(initialStatus, dotClass);
        }

        function updateStatus(text, dotClass) {
            document.getElementById('statusText').innerText = text;
            const dot = document.getElementById('statusDot');
            dot.className = 'status-dot ' + dotClass;
        }

        // --- REAL-TIME TYPING LOGIC ---

        const localInput = document.getElementById('local-text');
        
        function debouncedSend() {
            if (sendTimeout) clearTimeout(sendTimeout);
            
            sendTimeout = setTimeout(async () => {
                if (conn && conn.open) {
                    const rawText = localInput.value;
                    const encryptedPackage = await encryptData(rawText);
                    conn.send(encryptedPackage);
                }
            }, DEBOUNCE_MS);
        }

        localInput.addEventListener('input', () => {
            document.getElementById('local-char-count').textContent = localInput.value.length;
            debouncedSend();
        });

    </script>
</body>
</html>
